{"updatedAt":"2026-01-03T11:25:38.382Z","createdAt":"2026-01-03T11:12:23.212Z","id":"CADGkak356SDLyR5","name":"MCN Schedule Poller (5min)","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes"}]}},"name":"Every 5 Minutes","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1,"position":[0,0],"id":"ed1ec255-0b07-4a1d-ab61-fe2f13abab53"},{"parameters":{"url":"https://4t6f8tmh.api.sanity.io/v2024-01-01/data/query/production","sendQuery":true,"queryParameters":{"parameters":[{"name":"query","value":"*[_type == \"schedule\" && active == true] { ..., artist->, source_override[]-> }"}]},"options":{}},"name":"Fetch Schedules","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[208,0],"id":"09218190-32e4-4f8d-8daf-7ceb74bcacee"},{"parameters":{"jsCode":"// Sanity Schedule Matcher (Robust Edition)\n// Filters schedules that match the current time (UTC+8)\n\nconst now = new Date();\n// Adjust to Asia/Shanghai (UTC+8)\nconst utc8Time = new Date(now.getTime() + (8 * 60 * 60 * 1000));\n\nconst currentDay = utc8Time.getUTCDay(); // 0 (Sun) - 6 (Sat)\nconst currentDate = utc8Time.getUTCDate(); // 1 - 31\nconst currentHour = utc8Time.getUTCHours();\nconst currentMinute = utc8Time.getUTCMinutes();\n\n// Format current time HH:mm\nconst timeString = `${String(currentHour).padStart(2, '0')}:${String(currentMinute).padStart(2, '0')}`;\nconsole.log(`Checking schedules for: ${timeString} (Day: ${currentDay}, Date: ${currentDate})`);\n\nconst dayMap = {\n  'sunday': 0,\n  'monday': 1,\n  'tuesday': 2,\n  'wednesday': 3,\n  'thursday': 4,\n  'friday': 5,\n  'saturday': 6\n};\n\nreturn items[0].json.result.filter(schedule => {\n  if (!schedule.active) return false;\n\n  // === 1. One-off Logic ===\n  if (schedule.type === 'one_off') {\n    // TODO: Compare trigger_at with current window\n    return false;\n  }\n  \n  // === 2. Routine Logic ===\n  if (schedule.type === 'routine') {\n    const config = schedule.routine_config;\n    if (!config) return false;\n\n    // A. Time Check (Does 'times' array contain current HH:mm?)\n    if (!config.times || !config.times.includes(timeString)) {\n       return false;\n    }\n\n    // B. Date/Day Check\n    if (config.period === 'weekly') {\n        // Check text days [monday, friday...]\n        if (!config.days || config.days.length === 0) return false;\n        const todayParams = Object.keys(dayMap).find(key => dayMap[key] === currentDay);\n        return config.days.includes(todayParams);\n    }\n\n    if (config.period === 'monthly') {\n        // Check numeric dates [1, 15, 30]\n        if (!config.month_days || config.month_days.length === 0) return false;\n        return config.month_days.includes(currentDate);\n    }\n  }\n  return false;\n});"},"name":"Filter Matching Schedules","type":"n8n-nodes-base.code","typeVersion":1,"position":[400,0],"id":"9c182d85-7563-4136-a29e-f5f796f09a2d"},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $items.length > 0 }}","value2":true}]}},"name":"Any Matches?","type":"n8n-nodes-base.if","typeVersion":1,"position":[608,0],"id":"2a7f8272-301e-4881-9dcb-0cecd4c89ae4"},{"parameters":{"url":"http://localhost:5678/webhook/generate-post","options":{}},"name":"Trigger Post Generator","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[800,0],"id":"b1b413b6-3895-4c74-b943-9a0d82ac4a5c"}],"connections":{"Every 5 Minutes":{"main":[[{"node":"Fetch Schedules","type":"main","index":0}]]},"Fetch Schedules":{"main":[[{"node":"Filter Matching Schedules","type":"main","index":0}]]},"Filter Matching Schedules":{"main":[[{"node":"Any Matches?","type":"main","index":0}]]},"Any Matches?":{"main":[[{"node":"Trigger Post Generator","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":true,"timeSavedMode":"fixed","callerPolicy":"workflowsFromSameOwner"},"staticData":{"node:Every 5 Minutes":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"49452abc-26c1-4d24-be4b-49f2e7750fc2","activeVersionId":"49452abc-26c1-4d24-be4b-49f2e7750fc2","versionCounter":10,"triggerCount":1,"tags":[],"shared":[{"updatedAt":"2026-01-03T11:12:23.212Z","createdAt":"2026-01-03T11:12:23.212Z","role":"workflow:owner","workflowId":"CADGkak356SDLyR5","projectId":"wOmfMxRHwkGUETR9","project":{"updatedAt":"2026-01-03T11:09:31.859Z","createdAt":"2025-12-29T06:00:38.692Z","id":"wOmfMxRHwkGUETR9","name":"Jimmy Jing <jimmymjing@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"d6c23441-f1f1-43df-bd19-c9afe7016dc0"}}]}